<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2021-03-21 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Daniel Sagenschneider" />
    <meta name="Date-Revision-yyyymmdd" content="20210321" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Cosmos DB Tutorial &#x2013; CosmosDB Tutorial</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

          <!-- shortcut icon -->
			<link rel="shortcut icon" href="/favicon.ico" />
			
			<!-- www.addthis.com (for sharing) -->
			<script type="text/javascript">
				$(document).ready(function() {
					var addThisScript = document.createElement("script");
					addThisScript.type = 'text/javascript';
					addThisScript.src = '//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c6e0c0bac25d2cf';
					document.body.appendChild(addThisScript);
				})
			</script>
                  <!-- Google Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-23477455-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
          </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="https://github.com/officefloor/OfficeFloor">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="https://officefloor.net/" id="bannerLeft">
                                                                                        <img src="https://officefloor.net/images/OfficeFloorBannerImage.png"  alt="OfficeFloor"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                              <li class="">
                    <a href="../../index.html" title="OfficeFloor">
        OfficeFloor</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="../index.html" title="Tutorials">
        Tutorials</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="index.html" title="Cosmos DB Tutorial">
        Cosmos DB Tutorial</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">CosmosDB Tutorial</li>
        
              
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2021-03-21</li>
              <li id="projectVersion" class="pull-right">
                    Version: 3.33.0
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Parent Project</li>
                              
      <li>
  
                          <a href="../index.html" title="Tutorials">
          <span class="none"></span>
        Tutorials</a>
            </li>
            </ul>
              
                            <form id="search-form" action="https://www.google.com/search" method="get" >
    
  <input value="officefloor.net/officefloor/tutorials/CosmosDbHttpServer/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="https://cse.google.com/brand?form=search-form"></script>
          
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                                                                                                                   <a href="https://github.com/sponsors/sagenschneider" title="Support" class="builtBy">
        <img class="builtBy"  alt="Support" src="https://officefloor.net/images/sponsor.jpg"    />
      </a>
                      </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <div class="section">
<h2><a name="CosmosDB_Tutorial"></a>CosmosDB Tutorial</h2>
<p>This tutorial demonstrates using <a class="externalLink" href="https://docs.microsoft.com/azure/cosmos-db/">CosmosDB</a> to read/write data from Azure CosmosDB.</p>
<p>The example used in this tutorial is three end points:</p>
<ul>
<li><tt>POST /posts</tt> <tt>{&quot;message&quot;:&quot;Message to post&quot;}</tt> to create a post </li>
<li><tt>GET /posts/{id}</tt> to obtain a particular post</li>
<li><tt>GET /posts</tt> to obtain all posts</li></ul>
<p><a class="externalLink" href="https://github.com/officefloor/OfficeFloor/tree/master/officefloor/tutorials/CosmosDbHttpServer">Tutorial Source</a></p>
<div class="section">
<h3><a name="WoOF_configuration"></a>WoOF configuration</h3>
<p>The configuration of the end points are as follows:</p><img src="./images/CosmosDbHttpServer-configuration.png" alt="CosmosDbHttpServer screen shot." />
<p>With the implementation as follows:</p>
<div class="source"><pre class="prettyprint">public class CosmosDbLogic {

	public void savePost(Post post, CosmosEntities entities, ObjectResponse&lt;Post&gt; response) {
		CosmosContainer container = entities.getContainer(Post.class);
		Post created = container.createItem(new Post(UUID.randomUUID().toString(), post.getMessage())).getItem();
		response.send(created);
	}

	public void retrievePost(@HttpPathParameter(&quot;id&quot;) String identifier, CosmosEntities entities,
			ObjectResponse&lt;Post&gt; response) {
		CosmosContainer container = entities.getContainer(Post.class);
		PartitionKey partitionKey = entities.createPartitionKey(new Post());
		Post post = container.readItem(identifier, partitionKey, Post.class).getItem();
		response.send(post);
	}

	public void retrieveAllPosts(CosmosEntities entities, ObjectResponse&lt;Post[]&gt; response) {
		CosmosContainer container = entities.getContainer(Post.class);
		PartitionKey partitionKey = entities.createPartitionKey(new Post());
		Post[] posts = container.readAllItems(partitionKey, Post.class).stream().toArray(Post[]::new);
		response.send(posts);
	}
}
</pre></div>
<p>The CosmosDB entity is as follows:</p>
<div class="source"><pre class="prettyprint">@CosmosEntity(containerId = &quot;POST&quot;)
@HttpObject
@Data
@AllArgsConstructor
@NoArgsConstructor
@JsonIgnoreProperties(ignoreUnknown = true)
public class Post {

	private String id;

	private String message;

	@CosmosPartitionKey
	public String getPartitionKey() {
		return &quot;same&quot;;
	}
}
</pre></div>
<p>The Cosmos annotations are optional:</p>
<ul>
<li><a href="/apidocs/net/officefloor/nosql/cosmosdb/CosmosEntity.html">@CosmosEntity</a> allows specifying a container name. If not provided, then the class name is used for the container name.</li>
<li><a href="/apidocs/net/officefloor/nosql/cosmosdb/CosmosPartitionKey.html">@CosmosPartitionKey</a> flags a particular attribute as the partition key. If not provided, the <tt>id</tt> is used.</li></ul></div>
<div class="section">
<h3><a name="Configuring_CosmosDB"></a>Configuring CosmosDB</h3>
<p>The following dependency is required:</p>
<div class="source"><pre class="prettyprint">		&lt;dependency&gt;
			&lt;groupId&gt;net.officefloor.persistence&lt;/groupId&gt;
			&lt;artifactId&gt;officenosql_cosmosdb&lt;/artifactId&gt;
		&lt;/dependency&gt;
		
		&lt;!-- Required for testing --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;net.officefloor.persistence&lt;/groupId&gt;
			&lt;artifactId&gt;officenosql_cosmosdb_test&lt;/artifactId&gt;
			&lt;scope&gt;test&lt;/scope&gt;
		&lt;/dependency&gt;
</pre></div>
<p>CosmosDB is configured in <tt>application.objects</tt> as follows:</p>
<div class="source"><pre class="prettyprint">&lt;objects&gt;
	
	&lt;supplier source=&quot;net.officefloor.nosql.cosmosdb.CosmosDbSupplierSource&quot;&gt;
		&lt;property name=&quot;cosmos.entity.locators&quot; value=&quot;net.officefloor.tutorial.cosmosdbhttpserver.CosmosDbEntities&quot; /&gt;		
	&lt;/supplier&gt;
	
&lt;/objects&gt;
</pre></div>
<p>For performance reasons, the entities are not dynamically discovered. As Azure starts instances as required, the application must be brought up quickly to service the first request. Having to inspect all jars and classes for entities is typically too slow. Therefore, CosmosDB requires registering all entities with it manually.</p>
<p>Therefore, to make the entities available to CosmosDB, the following is the above configured class:</p>
<div class="source"><pre class="prettyprint">public class CosmosDbEntities implements CosmosEntityLocator {

	@Override
	public Class&lt;?&gt;[] locateEntities() throws Exception {
		return new Class[] { Post.class };
	}

}
</pre></div>
<p>Note: for third party libraries requiring to store data, it is also possible to register entities via a <a href="/apidocs/net/officefloor/nosql/cosmosdb/CosmosEntityLocatorServiceFactory.html">CosmosEntityLocatorServiceFactory</a>. This allows the entities to be automatically registered when the library is added to the class path.</p></div>
<div class="section">
<h3><a name="Testing"></a>Testing</h3>
<p>To make local testing easier, the following unit tests demonstrate automatically setting up a local data store for testing.</p>
<div class="source"><pre class="prettyprint">	@Order(1)
	@RegisterExtension
	public final CosmosDbExtension cosmosDb = new CosmosDbExtension().waitForCosmosDb();

	@Order(2)
	@RegisterExtension
	public final MockWoofServerExtension server = new MockWoofServerExtension();

	private @Dependency CosmosEntities entities;

	@Test
	public void ensureCreatePost() throws Exception {

		// Have server create the post
		Post post = new Post(null, &quot;TEST&quot;);
		MockWoofResponse response = this.server.send(MockWoofServer.mockJsonRequest(HttpMethod.POST, &quot;/posts&quot;, post));
		response.assertStatus(200);

		// Ensure post created
		PartitionKey partitionKey = this.entities.createPartitionKey(new Post());
		Post[] created = this.entities.getContainer(Post.class).readAllItems(partitionKey, Post.class).stream()
				.toArray(Post[]::new);
		assertEquals(1, created.length, &quot;Should only be one created post&quot;);
		assertEquals(&quot;TEST&quot;, created[0].getMessage(), &quot;Incorrect post&quot;);
	}
</pre></div>
<p>Note that this will start <a class="externalLink" href="https://www.npmjs.com/package/@zeit/cosmosdb-server">@zeit/cosmosdb-server</a> within a docker container to emulate CosmosDB. Unfortunately, the <a class="externalLink" href="https://docs.microsoft.com/en-us/azure/cosmos-db/local-emulator">Azure provided emulator</a> only runs on windows.</p>
<p>JUnit 4 example:</p>
<div class="source"><pre class="prettyprint">	private final CosmosDbRule dynamoDb = new CosmosDbRule().waitForCosmosDb();

	private final MockWoofServerRule server = new MockWoofServerRule(this);

	@Rule
	public final RuleChain ordered = RuleChain.outerRule(this.dynamoDb).around(this.server);

	private @Dependency CosmosEntities entities;

	@Test
	public void ensureCreatePost() throws Exception {

		// Have server create the post
		Post post = new Post(UUID.randomUUID().toString(), &quot;TEST&quot;);
		MockWoofResponse response = this.server.send(MockWoofServer.mockJsonRequest(HttpMethod.POST, &quot;/posts&quot;, post));
		response.assertStatus(200);

		// Ensure post created
		CosmosContainer container = this.entities.getContainer(Post.class);
		PartitionKey partitionKey = this.entities.createPartitionKey(post);
		Post[] created = container.readAllItems(partitionKey, Post.class).stream().toArray(Post[]::new);
		assertEquals(&quot;Should only be one created post&quot;, 1, created.length);
		assertEquals(&quot;Incorrect post&quot;, &quot;TEST&quot;, created[0].getMessage());
	}
</pre></div></div></div>
<div class="section">
<h2><a name="Next"></a>Next</h2>
<p>The <a href="../CosmosAsyncDbHttpServer/index.html">next tutorial</a> covers the <a class="externalLink" href="https://docs.microsoft.com/azure/cosmos-db/">CosmosDB</a> asynchronous client.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                                <p class="pull-right">Copyright &copy;                    2005&#x2013;2021
                        <a href="http://officefloor.net">OfficeFloor</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
