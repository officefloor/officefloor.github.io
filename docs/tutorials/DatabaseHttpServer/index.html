<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2020-10-28 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Daniel Sagenschneider" />
    <meta name="Date-Revision-yyyymmdd" content="20201028" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Database HTTP Server Tutorial &#x2013; Dependency Injection of Managed Object Tutorial</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

          <!-- shortcut icon -->
			<link rel="shortcut icon" href="/favicon.ico" />
			
			<!-- www.addthis.com (for sharing) -->
			<script type="text/javascript">
				$(document).ready(function() {
					var addThisScript = document.createElement("script");
					addThisScript.type = 'text/javascript';
					addThisScript.src = '//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c6e0c0bac25d2cf';
					document.body.appendChild(addThisScript);
				})
			</script>
                  <!-- Google Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-23477455-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
          </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="https://github.com/officefloor/OfficeFloor">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://www.officefloor.net/" id="bannerLeft">
                                                                                                <img src="../../images/OfficeFloorBannerImage.png"  alt="OfficeFloor"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                              <li class="">
                    <a href="../../index.html" title="OfficeFloor">
        OfficeFloor</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="../index.html" title="Tutorials">
        Tutorials</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="index.html" title="Database HTTP Server Tutorial">
        Database HTTP Server Tutorial</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Dependency Injection of Managed Object Tutorial</li>
        
              
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2020-10-28</li>
              <li id="projectVersion" class="pull-right">
                    Version: 3.28.0
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Parent Project</li>
                              
      <li>
  
                          <a href="../index.html" title="Tutorials">
          <span class="none"></span>
        Tutorials</a>
            </li>
            </ul>
              
                            <form id="search-form" action="https://www.google.com/search" method="get" >
    
  <input value="officefloor.net/officefloor/tutorials/DatabaseHttpServer/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="https://cse.google.com/brand?form=search-form"></script>
          
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                                                                                                                         <a href="https://github.com/sponsors/sagenschneider" title="Support" class="builtBy">
        <img class="builtBy"  alt="Support" src="../../images/sponsor.jpg"    />
      </a>
                      </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <div class="section">
<h2><a name="Dependency_Injection_of_Managed_Object_Tutorial"></a>Dependency Injection of Managed Object Tutorial</h2>
<p>This tutorial demonstrates the dependency injection of a <tt>Connection</tt>. The <tt>Connection</tt> is provided by a <a href="/apidocs/net/officefloor/frame/api/managedobject/source/ManagedObjectSource.html">ManagedObjectSource</a> implementation (i.e. <a href="/apidocs/net/officefloor/jdbc/ConnectionManagedObjectSource.html">ConnectionManagedObjectSource</a>).</p>
<p>A <a href="/apidocs/net/officefloor/frame/api/managedobject/source/ManagedObjectSource.html">ManagedObjectSource</a> enables injection of customised objects. The customised objects have greater access to OfficeFloor/WoOF functionality than plain old java objects (POJOs). OfficeFloor/WoOF, however, supports both as POJOs are simpler to implement.</p>
<p>The example used in this tutorial is the following simple application to manage rows within a database table.</p><img src="./images/DatabaseHttpServer-screenshot.png" alt="DatabaseHttpServer screen shot." />
<p><a class="externalLink" href="https://github.com/officefloor/OfficeFloor/tree/master/officefloor/tutorials/DatabaseHttpServer">Tutorial Source</a></p>
<div class="section">
<h3><a name="Configuring_Objects"></a>Configuring Objects</h3>
<p>Objects for dependency injection are configured in the <tt>application.objects</tt> file contained at the root of the class path. </p>
<p>Providing this file is optional. It is anticipated that features such as WoOF annotations and <a href="/apidocs/net/officefloor/compile/spi/supplier/source/SupplierSource.html">SupplierSource</a> implementations will provide the necessary dependencies for running a web application. See the <a href="../index.html">other tutorials</a> for more information. The file is however supported to extend WoOF web applications with additional custom dependencies.</p>
<p>The configuration of the dependency injected <tt>Connection</tt> is as follows.</p>
<div class="source"><pre class="prettyprint">&lt;objects&gt;

	&lt;managed-object source=&quot;net.officefloor.jdbc.ConnectionManagedObjectSource&quot; /&gt;

	&lt;managed-object source=&quot;net.officefloor.jdbc.DataSourceManagedObjectSource&quot;&gt;
		&lt;property-file path=&quot;datasource.properties&quot; /&gt;
	&lt;/managed-object&gt;

&lt;/objects&gt;
</pre></div>
<p>The <tt>Connection</tt> is provided by a <a href="/apidocs/net/officefloor/frame/api/managedobject/source/ManagedObjectSource.html">ManagedObjectSource</a> implementation that closes the connection on completion of the request. This depends on the <tt>DataSource</tt> to provide a managed <tt>Connection</tt>.</p>
<p>Properties to configure the <a href="/apidocs/net/officefloor/frame/api/managedobject/source/ManagedObjectSource.html">ManagedObjectSource</a> implementations can be provided in the above file or within a properties file.</p>
<p>The contents of configured property file is as follows.</p>
<div class="source"><pre class="prettyprint">datasource.class = org.h2.jdbcx.JdbcDataSource
url = jdbc:h2:mem:exampleDb;DB_CLOSE_DELAY=-1
user = sa
</pre></div>
<p>Objects to be dependency injected within OfficeFloor are made available by <a href="/apidocs/net/officefloor/frame/api/managedobject/source/ManagedObjectSource.html">ManagedObjectSource</a> implementations. Many dependency injection frameworks are based solely on the object's <tt>Class</tt> and its necessary dependency injection of other objects. OfficeFloor goes beyond this by providing more capabilities to the object such as invoking <a href="/apidocs/net/officefloor/frame/api/managedobject/source/ManagedObjectExecuteContext.html">processes</a>. For example the socket listener within a stand-alone WoOF HTTP Server is actually a <a href="/apidocs/net/officefloor/server/http/HttpServerSocketManagedObjectSource.html">HttpServerSocketManagedObjectSource</a> that invokes an OfficeFloor lightweight process to service the HTTP request.</p>
<p>The <a href="/apidocs/net/officefloor/plugin/managedobject/clazz/ClassManagedObjectSource.html">ClassManagedObjectSource</a> is available to provide the typical POJO dependency injection.</p></div>
<div class="section">
<h3><a name="Dependency_Injection"></a>Dependency Injection</h3>
<p>The following is the content of the template. </p>
<div class="source"><pre class="prettyprint">&lt;html&gt;
	&lt;body&gt;
		&lt;br /&gt;
		&lt;table border=&quot;1&quot;&gt;
			&lt;tr&gt;
				&lt;td&gt;Name&lt;/td&gt;
				&lt;td&gt;Description&lt;/td&gt;
				&lt;td&gt;Remove&lt;/td&gt;
			&lt;/tr&gt;
			&lt;!-- {Rows} --&gt;
			&lt;tr&gt;
				&lt;td&gt;${name}&lt;/td&gt;
				&lt;td&gt;${description}&lt;/td&gt;
				&lt;td&gt;&lt;a href=&quot;#{deleteRow}?id=${id}&quot;&gt;delete&lt;/a&gt;&lt;/td&gt;
			&lt;/tr&gt;
			&lt;!-- {EndRows} --&gt;
		&lt;/table&gt;
		&lt;br /&gt;
		&lt;form action=&quot;#{addRow}&quot; method=&quot;POST&quot;&gt;
			Name: &lt;input name=&quot;name&quot; type=&quot;text&quot; /&gt;
			Description: &lt;input name=&quot;description&quot; type=&quot;text&quot; /&gt;
			&lt;input type=&quot;submit&quot; value=&quot;Add&quot; /&gt;
		&lt;/form&gt;
	&lt;/body&gt;
&lt;/html&gt;
</pre></div>
<p>The table data is provided by the following method.</p>
<div class="source"><pre class="prettyprint">	public Row[] getRows(Connection connection) throws SQLException {

		// Obtain the row instances
		try (PreparedStatement statement = connection.prepareStatement(&quot;SELECT * FROM EXAMPLE ORDER BY ID&quot;)) {

			ResultSet resultSet = statement.executeQuery();
			List&lt;Row&gt; rows = new LinkedList&lt;Row&gt;();
			while (resultSet.next()) {
				rows.add(new Row(resultSet.getInt(&quot;ID&quot;), resultSet.getString(&quot;NAME&quot;),
						resultSet.getString(&quot;DESCRIPTION&quot;)));
			}

			// Return the row instances
			return rows.toArray(new Row[rows.size()]);
		}
	}
</pre></div>
<p>As the method is matched to the template by name, OfficeFloor uses the method's parameters to identify the necessary dependencies to be injected. In this case the only dependency is the <tt>Connection</tt> which was configured above.</p>
<p>WoOF auto-wires dependency injection based on type. Auto-wiring dependencies based on type is adequate (and much easier) for the majority of applications. WoOF's underlying OfficeFloor framework does provide manual dependency configuration, however this is seldom used as OfficeFloor allows qualifying dependencies for auto-wiring.</p>
<p>The handling of <tt> #{addRow} </tt> submission is via the following method.</p>
<div class="source"><pre class="prettyprint">	public void addRow(Row row, Connection connection) throws SQLException {

		// Add the row
		try (PreparedStatement statement = connection
				.prepareStatement(&quot;INSERT INTO EXAMPLE (NAME, DESCRIPTION) VALUES ( ?, ? )&quot;)) {
			statement.setString(1, row.getName());
			statement.setString(2, row.getDescription());
			statement.executeUpdate();

		}
	}
</pre></div>
<p>The method requires two parameters to be dependency injected. The <tt>Connection</tt> is dependency injected as above. The <tt>Row</tt> object below is also dependency injected by its WoOF annotation. See the <a href="../index.html">other tutorials</a> for more details on WoOF annotations.</p>
<div class="source"><pre class="prettyprint">@HttpParameters
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Row implements Serializable {
	private static final long serialVersionUID = 1L;

	private int id;

	private String name;

	private String description;
}
</pre></div>
<p>The delete row functionality is similar to the add functionality.</p>
<div class="source"><pre class="prettyprint">	public void deleteRow(@HttpQueryParameter(&quot;id&quot;) String id, Connection connection) throws SQLException {

		// Obtain the identifier
		int rowId = Integer.parseInt(id);

		// Delete the row
		try (PreparedStatement statement = connection.prepareStatement(&quot;DELETE FROM EXAMPLE WHERE ID = ?&quot;)) {
			statement.setInt(1, rowId);
			statement.executeUpdate();
		}
	}
</pre></div>
<p>After the add or delete method is executed the template is rendered again for the response back to the client. The rendering of the page executes the <tt>getRows(...)</tt> method again to display the changes within the table.</p></div>
<div class="section">
<h3><a name="Unit_Test"></a>Unit Test</h3>
<p>The unit test requests the page and then adds a row and deletes a row.</p>
<div class="source"><pre class="prettyprint">	@RegisterExtension
	public final MockWoofServerExtension server = new MockWoofServerExtension();

	@Test
	public void testInteraction(DataSource dataSource) throws Exception {
		try (Connection connection = dataSource.getConnection()) {

			// Request page
			this.server.send(MockWoofServer.mockRequest(&quot;/example&quot;));

			// Add row (will pick up parameter values from URL)
			MockWoofResponse response = this.server
					.send(MockWoofServer.mockRequest(&quot;/example+addRow?name=Daniel&amp;description=Founder&quot;));
			assertEquals(303, response.getStatus().getStatusCode(), &quot;Should follow POST then GET pattern&quot;);
			assertEquals(&quot;/example&quot;, response.getHeader(&quot;location&quot;).getValue(), &quot;Ensure redirect to load page&quot;);

			// Ensure row in database
			PreparedStatement statement = connection.prepareStatement(&quot;SELECT * FROM EXAMPLE WHERE NAME = 'Daniel'&quot;);
			ResultSet resultSet = statement.executeQuery();
			assertTrue(resultSet.next(), &quot;Should find row&quot;);
			assertEquals(&quot;Founder&quot;, resultSet.getString(&quot;DESCRIPTION&quot;), &quot;Ensure correct row&quot;);

			// Delete row
			this.server.send(MockWoofServer.mockRequest(&quot;/example+deleteRow?id=&quot; + resultSet.getInt(&quot;ID&quot;)));

			// Ensure row is deleted
			resultSet = statement.executeQuery();
			assertFalse(resultSet.next(), &quot;Row should be deleted&quot;);
		}
	}
</pre></div></div></div>
<div class="section">
<h2><a name="Next"></a>Next</h2>
<p>The <a href="../StartBeforeHttpServer/index.html">next tutorial</a> covers start up ordering of <a href="/apidocs/net/officefloor/frame/api/managedobject/source/ManagedObjectSource.html">ManagedObjectSource</a> instances.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                                <p class="pull-right">Copyright &copy;                    2005&#x2013;2020
                        <a href="http://officefloor.net">OfficeFloor</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
