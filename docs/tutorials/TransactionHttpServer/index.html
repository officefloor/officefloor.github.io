<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2020-11-24 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Daniel Sagenschneider" />
    <meta name="Date-Revision-yyyymmdd" content="20201124" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Transaction HTTP Server Tutorial &#x2013; Transaction HTTP Server Tutorial</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

          <!-- shortcut icon -->
			<link rel="shortcut icon" href="/favicon.ico" />
			
			<!-- www.addthis.com (for sharing) -->
			<script type="text/javascript">
				$(document).ready(function() {
					var addThisScript = document.createElement("script");
					addThisScript.type = 'text/javascript';
					addThisScript.src = '//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c6e0c0bac25d2cf';
					document.body.appendChild(addThisScript);
				})
			</script>
                  <!-- Google Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-23477455-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
          </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="https://github.com/officefloor/OfficeFloor">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://www.officefloor.net/" id="bannerLeft">
                                                                                                <img src="../../images/OfficeFloorBannerImage.png"  alt="OfficeFloor"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                              <li class="">
                    <a href="../../index.html" title="OfficeFloor">
        OfficeFloor</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="../index.html" title="Tutorials">
        Tutorials</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="index.html" title="Transaction HTTP Server Tutorial">
        Transaction HTTP Server Tutorial</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Transaction HTTP Server Tutorial</li>
        
              
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2020-11-24</li>
              <li id="projectVersion" class="pull-right">
                    Version: 3.28.2
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Parent Project</li>
                              
      <li>
  
                          <a href="../index.html" title="Tutorials">
          <span class="none"></span>
        Tutorials</a>
            </li>
            </ul>
              
                            <form id="search-form" action="https://www.google.com/search" method="get" >
    
  <input value="officefloor.net/officefloor/tutorials/TransactionHttpServer/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="https://cse.google.com/brand?form=search-form"></script>
          
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                                                                                                                         <a href="https://github.com/sponsors/sagenschneider" title="Support" class="builtBy">
        <img class="builtBy"  alt="Support" src="../../images/sponsor.jpg"    />
      </a>
                      </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <div class="section">
<h2><a name="Transaction_HTTP_Server_Tutorial"></a>Transaction HTTP Server Tutorial</h2>
<p>This tutorial demonstrates providing transaction context to an OfficeFloor web application. OfficeFloor refers to context as <a href="/apidocs/net/officefloor/frame/api/governance/Governance.html">Governance</a>.</p>
<p>The example used for this tutorial is adding posts via a REST service.</p>
<p><a class="externalLink" href="https://github.com/officefloor/OfficeFloor/tree/master/officefloor/tutorials/TransactionHttpServer">Tutorial Source</a></p>
<div class="section">
<h3><a name="Configuration"></a>Configuration</h3>
<p>The following is the <tt>application.woof</tt> configuration for the example application.</p><img src="./images/transaction-woof.png" alt="application.woof configuration." />
<div class="section">
<h4><a name="Transaction_.28Governance.29_configuration"></a>Transaction (Governance) configuration</h4>
<p>The transaction is managed via <a href="/apidocs/net/officefloor/compile/spi/governance/source/GovernanceSource.html">GovernanceSource</a>. This is a generic means to provide context around logic with the application.</p>
<p>In this particular case, the <a href="/apidocs/net/officefloor/spring/data/SpringDataTransactionGovernanceSource.html">SpringDataTransactionGovernanceSource</a> is used to provide transaction management over Spring repositories.</p>
<p>To enable transaction management, add a Governance item. Once added, the scope of the transaction (governance) must be specified. This is achieved by adding the area around all logic in scope for the transaction. Logic components within the area will be managed by the transaction.</p>
<p>The transaction will be started when flow moves from a logic component outside the area to a logic component within the area.</p>
<p>The transaction will end in either two ways:</p>
<ul>
<li>normal flow moves to a logic component outside the transaction (causing the transaction to commit)</li>
<li>exception handling outside the area (causing the transaction to rollback)</li></ul>
<p>Note: that exception handling within the transaction area will continue the transaction.</p>
<p>Note: completing the flow within the transaction scope also commits the transaction.</p></div></div>
<div class="section">
<h3><a name="Application_logic"></a>Application logic</h3>
<p>The transactional logic is as follows:</p>
<div class="source"><pre class="prettyprint">public class TransactionLogic {

	public IllegalArgumentException rollback(Post post, PostRepository repository) {
		repository.save(post);
		return new IllegalArgumentException(&quot;rolled back&quot;);
	}

	public EOFException commit(Post post, PostRepository repository) throws EOFException {
		repository.save(post);
		return new EOFException(&quot;committed&quot;);
	}

	public void fail(@Parameter Exception failure, PostRepository repository, TeamMarkerBean marker) throws Exception {
		repository.save(new Post(null, &quot;Additional&quot;));
		throw failure;
	}

}
</pre></div>
<p>This will attempt to write two posts to the database. As per the configuration, the exception handled is either within the transaction (committing) or outside (roll back).</p>
<div class="section">
<h4><a name="Spring_Data_integration"></a>Spring Data integration</h4>
<p>The application also has the following <a href="/apidocs/net/officefloor/frame/api/team/Team.html">Team</a> configuration to demonstrate Spring Data transaction working across threads.</p>
<div class="source"><pre class="prettyprint">&lt;teams&gt;

	&lt;!-- Demonstrates Spring Data Transaction working across different threads --&gt;
	&lt;team source=&quot;net.officefloor.frame.impl.spi.team.ExecutorCachedTeamSource&quot; type=&quot;net.officefloor.tutorial.transactionhttpserver.TeamMarkerBean&quot; /&gt;

&lt;/teams&gt;
</pre></div>
<p>To enable use of Spring data in OfficeFloor's multi-threaded <a href="/apidocs/net/officefloor/frame/api/team/Team.html">Team</a> environment, add the following dependency:</p>
<div class="source"><pre class="prettyprint">		&lt;dependency&gt;
			&lt;groupId&gt;net.officefloor.spring&lt;/groupId&gt;
			&lt;artifactId&gt;officespring_data&lt;/artifactId&gt;
		&lt;/dependency&gt;
</pre></div>
<p>This will ensure the Spring Data transaction thread locals are propagated across Threads. </p></div></div>
<div class="section">
<h3><a name="Unit_Test"></a>Unit Test</h3>
<p>The following unit test demonstrates committing the transaction (as exception handled within transaction). </p>
<div class="source"><pre class="prettyprint">	@RegisterExtension
	public final MockWoofServerExtension server = new MockWoofServerExtension();

	private static final String POST_CONTENT = &quot;Interesting post article&quot;;

	@Test
	public void commit() throws Exception {

		// Create, will handle exception and commit
		MockWoofResponse response = this.server
				.send(MockWoofServer.mockJsonRequest(HttpMethod.POST, &quot;/commit&quot;, new Post(null, POST_CONTENT)));
		response.assertResponse(201, &quot;committed&quot;);

		// Ensure persisted to database
		response = this.server.send(MockWoofServer.mockRequest(&quot;/posts&quot;));
		response.assertJson(200, Arrays.asList(new Post(1, POST_CONTENT), new Post(2, &quot;Additional&quot;)));
	}
</pre></div>
<p>The following unit test demonstrates rolling back the transaction (as exception handled outside transaction scope).</p>
<div class="source"><pre class="prettyprint">	@Test
	public void rollback() throws Exception {

		// Attempt to create (but should roll back)
		MockWoofResponse response = this.server
				.send(MockWoofServer.mockJsonRequest(HttpMethod.POST, &quot;/rollback&quot;, new Post(null, POST_CONTENT)));
		response.assertResponse(500, &quot;rolled back&quot;);

		// Ensure not persisted to database
		response = this.server.send(MockWoofServer.mockRequest(&quot;/posts&quot;));
		response.assertJson(200, Arrays.asList());
	}
</pre></div></div></div>
<div class="section">
<h2><a name="Next"></a>Next</h2>
<p>The <a href="../VariableHttpServer/index.html">next tutorial</a> covers variables.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                                <p class="pull-right">Copyright &copy;                    2005&#x2013;2020
                        <a href="http://officefloor.net">OfficeFloor</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
