<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2020-12-12 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Daniel Sagenschneider" />
    <meta name="Date-Revision-yyyymmdd" content="20201212" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Environment configuration HTTP Server Tutorial &#x2013; Environment Tutorial</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

          <!-- shortcut icon -->
			<link rel="shortcut icon" href="/favicon.ico" />
			
			<!-- www.addthis.com (for sharing) -->
			<script type="text/javascript">
				$(document).ready(function() {
					var addThisScript = document.createElement("script");
					addThisScript.type = 'text/javascript';
					addThisScript.src = '//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c6e0c0bac25d2cf';
					document.body.appendChild(addThisScript);
				})
			</script>
                  <!-- Google Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-23477455-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
          </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="https://github.com/officefloor/OfficeFloor">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="https://officefloor.net/" id="bannerLeft">
                                                                                        <img src="https://officefloor.net/images/OfficeFloorBannerImage.png"  alt="OfficeFloor"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                              <li class="">
                    <a href="../../index.html" title="OfficeFloor">
        OfficeFloor</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="../index.html" title="Tutorials">
        Tutorials</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="index.html" title="Environment configuration HTTP Server Tutorial">
        Environment configuration HTTP Server Tutorial</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Environment Tutorial</li>
        
              
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2020-12-12</li>
              <li id="projectVersion" class="pull-right">
                    Version: 3.29.0
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Parent Project</li>
                              
      <li>
  
                          <a href="../index.html" title="Tutorials">
          <span class="none"></span>
        Tutorials</a>
            </li>
            </ul>
              
                            <form id="search-form" action="https://www.google.com/search" method="get" >
    
  <input value="officefloor.net/officefloor/tutorials/EnvironmentHttpServer/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="https://cse.google.com/brand?form=search-form"></script>
          
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                                                                                                                   <a href="https://github.com/sponsors/sagenschneider" title="Support" class="builtBy">
        <img class="builtBy"  alt="Support" src="https://officefloor.net/images/sponsor.jpg"    />
      </a>
                      </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <div class="section">
<h2><a name="Environment_Tutorial"></a>Environment Tutorial</h2>
<p>This tutorial covers configuring WoOF within different environments. It will look at configuring individual properties and then discuss profiles for easier grouping of properties.</p>
<p>The example used in this tutorial is the following simple server to provide an environment specific response.</p><img src="./images/EnvironmentHttpServer-configuration.png" alt="EnvironmentHttpServer configuration." />
<p><a class="externalLink" href="https://github.com/officefloor/OfficeFloor/tree/master/officefloor/tutorials/EnvironmentHttpServer">Tutorial Source</a></p></div>
<div class="section">
<h2><a name="Inject_Property"></a>Inject Property</h2>
<p>The following is the procedure implementation:</p>
<div class="source"><pre class="prettyprint">public class EnvironmentLogic {

	public void service(@Property(&quot;name&quot;) String value, ServerHttpConnection connection) throws IOException {
		connection.getResponse().getEntityWriter().write(value);
	}
}
</pre></div>
<p>The <a href="/apidocs/net/officefloor/plugin/clazz/Property.html">@Property</a> annotation flags for the named property to be injected. Names of properties are qualified by the name of procedure. This enables simple names for easy configuration.</p>
<p>As per the code, the procedure will respond with the value of the property.</p></div>
<div class="section">
<h2><a name="Configuring_Properties"></a>Configuring Properties</h2>
<p>The default properties are configured in the <tt>application.properties</tt> file (at root of class path). The content of this tutorial's file is the following:</p>
<div class="source"><pre class="prettyprint">service.procedure.name=DEFAULT
</pre></div>
<p>As mentioned, the property name is prefixed with the procedure name.</p>
<p>The following unit test shows returning the default property:</p>
<div class="source"><pre class="prettyprint">	@RegisterExtension
	public final MockWoofServerExtension server = new MockWoofServerExtension();

	@Test
	public void applicationProperties() {
		this.server.send(MockWoofServer.mockRequest(&quot;/&quot;)).assertResponse(200, &quot;DEFAULT&quot;);
	}
</pre></div>
<p>JUnit 4 example:</p>
<div class="source"><pre class="prettyprint">	@Rule
	public final MockWoofServerRule server = new MockWoofServerRule(this);

	@Test
	public void applicationProperties() {
		this.server.send(MockWoofServer.mockRequest(&quot;/&quot;)).assertResponse(200, &quot;DEFAULT&quot;);
	}
</pre></div>
<div class="section">
<h3><a name="Testing"></a>Testing</h3>
<p>Tests may override the property:</p>
<div class="source"><pre class="prettyprint">	@RegisterExtension
	public final MockWoofServerExtension server = new MockWoofServerExtension().property(&quot;service.procedure.name&quot;,
			&quot;PROPERTY&quot;);

	@Test
	public void applicationProperties() {
		this.server.send(MockWoofServer.mockRequest(&quot;/&quot;)).assertResponse(200, &quot;PROPERTY&quot;);
	}
</pre></div>
<p>JUnit 4 example:</p>
<div class="source"><pre class="prettyprint">	@Rule
	public final MockWoofServerRule server = new MockWoofServerRule(this).property(&quot;service.procedure.name&quot;,
			&quot;PROPERTY&quot;);

	@Test
	public void applicationProperties() {
		this.server.send(MockWoofServer.mockRequest(&quot;/&quot;)).assertResponse(200, &quot;PROPERTY&quot;);
	}
</pre></div>
<p>Note that externally configured properties, detailed in the rest of this tutorial, are not loaded by the mock server. This avoids false positive tests that may fail due to environment differences.</p></div>
<div class="section">
<h3><a name="System"></a>System</h3>
<p>When running the application, system properties can be used to override the properties:</p>
<div class="source"><pre class="prettyprint">	@Order(1)
	@RegisterExtension
	public final SystemPropertiesExtension systemProperties = new SystemPropertiesExtension()
			.property(&quot;application.service.procedure.name&quot;, &quot;SYSTEM&quot;);

	@Order(2)
	@RegisterExtension
	public final OfficeFloorExtension officeFloor = new OfficeFloorExtension();

	@Order(3)
	@RegisterExtension
	public final HttpClientExtension client = new HttpClientExtension();

	@Test
	public void systemProperty() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;SYSTEM&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div>
<p>JUnit 4 example:</p>
<div class="source"><pre class="prettyprint">	private final SystemPropertiesRule systemProperties = new SystemPropertiesRule()
			.property(&quot;application.service.procedure.name&quot;, &quot;SYSTEM&quot;);

	private final OfficeFloorRule officeFloor = new OfficeFloorRule(this);

	private final HttpClientRule client = new HttpClientRule();

	@Rule
	public final RuleChain order = RuleChain.outerRule(this.systemProperties).around(this.officeFloor)
			.around(this.client);

	@Test
	public void systemProperty() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;SYSTEM&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div></div>
<div class="section">
<h3><a name="Environment"></a>Environment</h3>
<p>For environments (such as cloud), properties may be overridden by environment variables. To distinguish the environment variables, notice the prefix on the name.</p>
<div class="source"><pre class="prettyprint">	@Order(1)
	@RegisterExtension
	public final EnvironmentExtension environment = new EnvironmentExtension()
			.property(&quot;OFFICEFLOOR.application.service.procedure.name&quot;, &quot;ENVIRONMENT&quot;);

	@Order(2)
	@RegisterExtension
	public final OfficeFloorExtension officeFloor = new OfficeFloorExtension();

	@Order(3)
	@RegisterExtension
	public final HttpClientExtension client = new HttpClientExtension();

	@Test
	public void environment() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;ENVIRONMENT&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div>
<p>JUnit 4 example:</p>
<div class="source"><pre class="prettyprint">	private final EnvironmentRule environment = new EnvironmentRule()
			.property(&quot;OFFICEFLOOR.application.service.procedure.name&quot;, &quot;ENVIRONMENT&quot;);

	private final OfficeFloorRule officeFloor = new OfficeFloorRule(this);

	private final HttpClientRule client = new HttpClientRule();

	@Rule
	public final RuleChain order = RuleChain.outerRule(this.environment).around(this.officeFloor).around(this.client);

	@Test
	public void environment() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;ENVIRONMENT&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div></div>
<div class="section">
<h3><a name="User_Home"></a>User Home</h3>
<p>There are times when information is sensitive and can't be made available in the environment or in cloud configuration. In these circumstances, the configuration files can reside in the process's user home directory. This ensures the sensitive information is only on the servers requiring the information and are accessed only by the user requiring it. The following demonstrates overriding with the user properties:</p>
<div class="source"><pre class="prettyprint">	@Order(1)
	@RegisterExtension
	public final SystemPropertiesExtension systemProperties = new SystemPropertiesExtension().property(&quot;user.home&quot;,
			new File(&quot;./target/test-classes&quot;).getAbsolutePath());

	@Order(2)
	@RegisterExtension
	public final OfficeFloorExtension officeFloor = new OfficeFloorExtension();

	@Order(3)
	@RegisterExtension
	public final HttpClientExtension client = new HttpClientExtension();

	@Test
	public void userHome() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;USER&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div>
<p>JUnit 4 example:</p>
<div class="source"><pre class="prettyprint">	private final SystemPropertiesRule systemProperties = new SystemPropertiesRule().property(&quot;user.home&quot;,
			new File(&quot;./target/test-classes&quot;).getAbsolutePath());

	private final OfficeFloorRule officeFloor = new OfficeFloorRule(this);

	private final HttpClientRule client = new HttpClientRule();

	@Rule
	public final RuleChain order = RuleChain.outerRule(this.systemProperties).around(this.officeFloor)
			.around(this.client);

	@Test
	public void userHome() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;USER&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div>
<p>The property comes from the <tt>[user's home directory]/.config/officefloor/application.properties</tt>, which for this tutorial contains:</p>
<div class="source"><pre class="prettyprint">service.procedure.name=USER
</pre></div></div></div>
<div class="section">
<h2><a name="Profiles"></a>Profiles</h2>
<p>Configuring property overrides can be a lot of external configuration to the application. This can create a lot of overheads in keeping the externally configured properties in line with the ever evolving application.</p>
<p>Profiles provide means to activate an internal set of properties for the application.</p>
<div class="section">
<h3><a name="Testing"></a>Testing</h3>
<p>The following test activates an additional profile:</p>
<div class="source"><pre class="prettyprint">	@RegisterExtension
	public final MockWoofServerExtension server = new MockWoofServerExtension().profile(&quot;mock&quot;);

	@Test
	public void applicationProperties() {
		this.server.send(MockWoofServer.mockRequest(&quot;/&quot;)).assertResponse(200, &quot;MOCK&quot;);
	}
</pre></div>
<p>JUnit 4 example:</p>
<div class="source"><pre class="prettyprint">	@Rule
	public final MockWoofServerRule server = new MockWoofServerRule(this).profile(&quot;mock&quot;);

	@Test
	public void applicationProperties() {
		this.server.send(MockWoofServer.mockRequest(&quot;/&quot;)).assertResponse(200, &quot;MOCK&quot;);
	}
</pre></div>
<p>This test will load the default properties from <tt>application.properties</tt>. It will then override the properties with the set of properties from <tt>application-mock.properties</tt>. Notice the hyphen and profile name. This naming convention identifies the file containing the properties for a profile. For this tutorial the file contains:</p>
<div class="source"><pre class="prettyprint">service.procedure.name=MOCK
</pre></div>
<p>As the configured profile takes precedence, the profile's property is used.</p>
<p>Note the mock server will always activate the <tt>test</tt> profile for test specific properties.</p></div>
<div class="section">
<h3><a name="System"></a>System</h3>
<p>Running applications can also benefit from profiles. The profile may be activated by a system property: </p>
<div class="source"><pre class="prettyprint">	@Order(1)
	@RegisterExtension
	public final SystemPropertiesExtension systemProperties = new SystemPropertiesExtension()
			.property(WoOF.DEFAULT_OFFICE_PROFILES, &quot;system&quot;);

	@Order(2)
	@RegisterExtension
	public final OfficeFloorExtension officeFloor = new OfficeFloorExtension();

	@Order(3)
	@RegisterExtension
	public final HttpClientExtension client = new HttpClientExtension();

	@Test
	public void systemProfile() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;SYSTEM&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div>
<p>JUnit 4 example:</p>
<div class="source"><pre class="prettyprint">	private final SystemPropertiesRule systemProperties = new SystemPropertiesRule()
			.property(WoOF.DEFAULT_OFFICE_PROFILES, &quot;system&quot;);

	private final OfficeFloorRule officeFloor = new OfficeFloorRule(this);

	private final HttpClientRule client = new HttpClientRule();

	@Rule
	public final RuleChain order = RuleChain.outerRule(this.systemProperties).around(this.officeFloor)
			.around(this.client);

	@Test
	public void systemProfile() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;SYSTEM&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div>
<p>The contents of the respective profile properties file is:</p>
<div class="source"><pre class="prettyprint">service.procedure.name=SYSTEM
</pre></div></div>
<div class="section">
<h3><a name="Environment"></a>Environment</h3>
<p>Environment variables may also activate a profile:</p>
<div class="source"><pre class="prettyprint">	@Order(1)
	@RegisterExtension
	public final EnvironmentExtension environment = new EnvironmentExtension()
			.property(&quot;OFFICEFLOOR.application.profiles&quot;, &quot;environment&quot;);

	@Order(2)
	@RegisterExtension
	public final OfficeFloorExtension officeFloor = new OfficeFloorExtension();

	@Order(3)
	@RegisterExtension
	public final HttpClientExtension client = new HttpClientExtension();

	@Test
	public void environment() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;ENVIRONMENT&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div>
<p>JUnit 4 example:</p>
<div class="source"><pre class="prettyprint">	private final EnvironmentRule environment = new EnvironmentRule().property(&quot;OFFICEFLOOR.application.profiles&quot;,
			&quot;environment&quot;);

	private final OfficeFloorRule officeFloor = new OfficeFloorRule(this);

	private final HttpClientRule client = new HttpClientRule();

	@Rule
	public final RuleChain order = RuleChain.outerRule(this.environment).around(this.officeFloor).around(this.client);

	@Test
	public void environment() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;ENVIRONMENT&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div>
<p>The contents of the respective profile properties file is:</p>
<div class="source"><pre class="prettyprint">service.procedure.name=ENVIRONMENT
</pre></div></div>
<div class="section">
<h3><a name="User_Home"></a>User Home</h3>
<p>For environments with pre-built images (e.g. docker), it is possible to configure profile property files in the user's home directory. These profiles can then be activated by the environment. For example:</p>
<div class="source"><pre class="prettyprint">	@Order(1)
	@RegisterExtension
	public final SystemPropertiesExtension systemProperties = new SystemPropertiesExtension()
			.property(&quot;user.home&quot;, new File(&quot;./target/test-classes&quot;).getAbsolutePath())
			.property(WoOF.DEFAULT_OFFICE_PROFILES, &quot;user&quot;);

	@Order(2)
	@RegisterExtension
	public final OfficeFloorExtension officeFloor = new OfficeFloorExtension();

	@Order(3)
	@RegisterExtension
	public final HttpClientExtension client = new HttpClientExtension();

	@Test
	public void userHome() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;USER_PROFILE&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div>
<p>JUnit 4 example:</p>
<div class="source"><pre class="prettyprint">	private final SystemPropertiesRule systemProperties = new SystemPropertiesRule()
			.property(&quot;user.home&quot;, new File(&quot;./target/test-classes&quot;).getAbsolutePath())
			.property(WoOF.DEFAULT_OFFICE_PROFILES, &quot;user&quot;);

	private final OfficeFloorRule officeFloor = new OfficeFloorRule(this);

	private final HttpClientRule client = new HttpClientRule();

	@Rule
	public final RuleChain order = RuleChain.outerRule(this.systemProperties).around(this.officeFloor)
			.around(this.client);

	@Test
	public void userHome() throws IOException {
		HttpResponse response = this.client.execute(new HttpGet(&quot;http://localhost:7878&quot;));
		assertEquals(&quot;Should be successful&quot;, 200, response.getStatusLine().getStatusCode());
		assertEquals(&quot;Incorrect property override&quot;, &quot;USER_PROFILE&quot;, EntityUtils.toString(response.getEntity()));
	}
</pre></div>
<p>Again, the properties files are located in <tt>[user's home directory]/.config/officefloor</tt>. They following the profile naming convention. For the above example this would be <tt>application-user.properties</tt> and contains:</p>
<div class="source"><pre class="prettyprint">service.procedure.name=USER_PROFILE
</pre></div></div></div>
<div class="section">
<h2><a name="Next"></a>Next</h2>
<p>The <a href="../DeployHttpServer/index.html">next tutorial</a> looks at deploying OfficeFloor applications.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                                <p class="pull-right">Copyright &copy;                    2005&#x2013;2020
                        <a href="http://officefloor.net">OfficeFloor</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
