<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2021-05-05 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Daniel Sagenschneider" />
    <meta name="Date-Revision-yyyymmdd" content="20210505" />
    <meta http-equiv="Content-Language" content="en" />
    <title>JWT Separate Authority Server Tutorial (Authority Server) &#x2013; JWT Authority Tutorial</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

          <!-- shortcut icon -->
			<link rel="shortcut icon" href="/favicon.ico" />
			
			<!-- www.addthis.com (for sharing) -->
			<script type="text/javascript">
				$(document).ready(function() {
					var addThisScript = document.createElement("script");
					addThisScript.type = 'text/javascript';
					addThisScript.src = '//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c6e0c0bac25d2cf';
					document.body.appendChild(addThisScript);
				})
			</script>
                  <!-- Google Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-23477455-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
          </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="https://github.com/officefloor/OfficeFloor">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="https://officefloor.net/" id="bannerLeft">
                                                                                        <img src="https://officefloor.net/images/OfficeFloorBannerImage.png"  alt="OfficeFloor"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                              <li class="">
                    <a href="../../index.html" title="OfficeFloor">
        OfficeFloor</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="../index.html" title="Tutorials">
        Tutorials</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="index.html" title="JWT Separate Authority Server Tutorial (Authority Server)">
        JWT Separate Authority Server Tutorial (Authority Server)</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">JWT Authority Tutorial</li>
        
              
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2021-05-05</li>
              <li id="projectVersion" class="pull-right">
                    Version: 3.35.0
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Parent Project</li>
                              
      <li>
  
                          <a href="../index.html" title="Tutorials">
          <span class="none"></span>
        Tutorials</a>
            </li>
            </ul>
              
                            <form id="search-form" action="https://www.google.com/search" method="get" >
    
  <input value="officefloor.net/officefloor/tutorials/JwtAuthorityHttpServer/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="https://cse.google.com/brand?form=search-form"></script>
          
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                                                                                                                   <a href="https://github.com/sponsors/sagenschneider" title="Support" class="builtBy">
        <img class="builtBy"  alt="Support" src="https://officefloor.net/images/sponsor.jpg"    />
      </a>
                      </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <div class="section">
<h2><a name="JWT_Authority_Tutorial"></a>JWT Authority Tutorial</h2>
<p>This tutorial demonstrates providing a JWT authority server.</p>
<p>The example used in this tutorial has the end points:</p>
<ul>
<li><tt>POST /login</tt> to login to retrieve the JWT refresh and access tokens</li>
<li><tt>POST /refresh</tt> to refresh the access token</li>
<li><tt>GET /jwks.json</tt> to retrieve the JWT keys as per JWKS</li></ul>
<p><a class="externalLink" href="https://github.com/officefloor/OfficeFloor/tree/master/officefloor/tutorials/JwtAuthorityHttpServer">Tutorial Source</a></p>
<div class="section">
<h3><a name="WoOF_configuration"></a>WoOF configuration</h3>
<p>The configuration is the following:</p><img src="./images/JwtAuthorityHttpServer-configuration.png" alt="JwtAuthorityHttpServer screen shot." />
<p>with the following objects:</p>
<div class="source"><pre class="prettyprint">&lt;objects&gt;

	&lt;managed-object source=&quot;net.officefloor.web.jwt.authority.JwtAuthorityManagedObjectSource&quot;&gt;
		&lt;property name=&quot;identity.class&quot; value=&quot;net.officefloor.tutorial.jwtauthorityhttpserver.Identity&quot; /&gt;
	&lt;/managed-object&gt;

	&lt;managed-object source=&quot;net.officefloor.tutorial.jwtauthorityhttpserver.InMemoryJwtAuthorityRepositoryManagedObjectSource&quot; /&gt;

&lt;/objects&gt;
</pre></div></div>
<div class="section">
<h3><a name="JWT_Authority"></a>JWT Authority</h3>
<p>As per the objects above, the <a href="/apidocs/net/officefloor/web/jwt/authority/JwtAuthorityManagedObjectSource.html">JwtAuthorityManagedObjectSource</a> provides the <a href="/apidocs/net/officefloor/web/jwt/authority/JwtAuthority.html">JwtAuthority</a>. This provides the necessary means for creating and refreshing the tokens for a JWT authority server.</p>
<p>This requires persisting the keys and depends on a <a href="/apidocs/net/officefloor/web/jwt/authority/repository/JwtAuthorityRepository.html">JwtAuthorityRepository</a> to provide this persistence. This allows a cluster of JWT authority servers sharing the same persistent storage of keys.</p></div>
<div class="section">
<h3><a name="Login"></a>Login</h3>
<p>Login is specific to the JWT authentication server. It can use it's own store of credentials. It may use third party Open ID servers. Once authenticated, then the tokens may be created:</p>
<div class="source"><pre class="prettyprint">	public static final String REFRESH_TOKEN_COOKIE_NAME = &quot;RefreshToken&quot;;

	@Data
	@HttpObject
	@RequiredArgsConstructor
	@AllArgsConstructor
	public static class Credentials {
		private String username;
		private String password;
	}

	@Data
	@HttpObject
	@AllArgsConstructor
	@RequiredArgsConstructor
	public static class Token {
		private String token;
	}

	public void login(Credentials credentials, JwtAuthority&lt;Identity&gt; authority, ObjectResponse&lt;Token&gt; response,
			ServerHttpConnection connection) {

		// Mock authentication
		// (production solution would restrict tries and check appropriate user store)
		// (or use potential OpenId third party login)
		if ((credentials.getUsername() == null) || (!credentials.getUsername().equals(credentials.getPassword()))) {
			throw new HttpException(HttpStatus.UNAUTHORIZED);
		}

		// Create the refresh token from identity
		Identity identity = new Identity(credentials.username);
		RefreshToken refreshToken = authority.createRefreshToken(identity);

		// Provide refresh token
		connection.getResponse().getCookies().setCookie(REFRESH_TOKEN_COOKIE_NAME, refreshToken.getToken())
				.setHttpOnly(true).setSecure(true).setExpires(Instant.ofEpochSecond(refreshToken.getExpireTime()));

		// Create the access token
		Claims claims = createClaims(credentials.username);
		AccessToken accessToken = authority.createAccessToken(claims);

		// Send response
		response.send(new Token(accessToken.getToken()));
	}

	private static Claims createClaims(String username) {

		// Mock claims
		// (claim information should be pulled from user store)
		String[] roles = new String[] { &quot;tutorial&quot; };

		// Provide random value (so access tokens are different)
		// (not necessary but due to speed of tests, gets same access token)
		int randomValue = ThreadLocalRandom.current().nextInt();

		// Return the claims
		return new Claims(username, randomValue, roles);
	}
</pre></div></div>
<div class="section">
<h3><a name="Refreshing_Access_Tokens"></a>Refreshing Access Tokens</h3>
<p>Access tokens, as per JWT, should be short lived. Refresh tokens maintain the length of the session for the user. Using a refresh token, access tokens can be obtained until the refresh token expires:</p>
<div class="source"><pre class="prettyprint">	public void refreshAccessToken(ServerHttpConnection connection, JwtAuthority&lt;Identity&gt; authority,
			ObjectResponse&lt;Token&gt; response) {

		// Obtain the refresh token
		HttpRequestCookie cookie = connection.getRequest().getCookies().getCookie(REFRESH_TOKEN_COOKIE_NAME);
		if (cookie == null) {
			throw new HttpException(HttpStatus.UNAUTHORIZED);
		}
		String refreshToken = cookie.getValue();

		// Obtain the identity from refresh token
		Identity identity = authority.decodeRefreshToken(refreshToken);

		// Create a new access token
		Claims claims = createClaims(identity.getId());
		AccessToken accessToken = authority.createAccessToken(claims);

		// Send refreshed access token
		response.send(new Token(accessToken.getToken()));
	}
</pre></div>
<p>Once the refresh token is expired, the user is likely required to re-authenticate. However, this again is application specific, as refresh tokens may be recreated also.</p></div>
<div class="section">
<h3><a name="JWKS_publishing"></a>JWKS publishing </h3>
<p>RFC 7517 defines a format for publishing keys. The tutorial uses the default <a href="/apidocs/net/officefloor/web/jwt/authority/jwks/JwksPublishSectionSource.html">JwksPublishSectionSource</a> that adheres to this format to publish keys.</p></div>
<div class="section">
<h3><a name="Testing"></a>Testing</h3>
<p>The following shows the ease of using the JWT authority:</p>
<div class="source"><pre class="prettyprint">public class JwtAuthorityHttpServerTest {

	@RegisterExtension
	public MockWoofServerExtension server = new MockWoofServerExtension();

	private String refreshToken;

	private String accessToken;

	@Test
	public void login() throws Exception {

		// Undertake login
		Credentials credentials = new Credentials(&quot;daniel&quot;, &quot;daniel&quot;);
		MockWoofResponse response = this.server
				.send(MockWoofServer.mockJsonRequest(HttpMethod.POST, &quot;/login&quot;, credentials).secure(true));
		assertEquals(200, response.getStatus().getStatusCode(), &quot;Should be successful&quot;);

		// Extract the refresh token
		WritableHttpCookie cookie = response.getCookie(JwtTokens.REFRESH_TOKEN_COOKIE_NAME);
		assertNotNull(cookie, &quot;Should have refresh token&quot;);

		// Extract the access token
		Token accessToken = response.getJson(200, Token.class);
		assertNotNull(accessToken.getToken(), &quot;Should have access token&quot;);

		// Capture for other tests
		this.refreshToken = cookie.getValue();
		this.accessToken = accessToken.getToken();
	}

	@Test
	public void refreshAccessToken() throws Exception {

		// Undertake login to obtain refresh token
		this.login();

		// Attempt to obtain access token without refresh token
		MockWoofResponse response = this.server
				.send(MockWoofServer.mockRequest(&quot;/refresh&quot;).secure(true).method(HttpMethod.POST));
		assertEquals(401, response.getStatus().getStatusCode(), &quot;Should not be authorised&quot;);

		// Obtain new access token with refresh token
		response = this.server.send(MockWoofServer.mockRequest(&quot;/refresh&quot;).secure(true).method(HttpMethod.POST)
				.cookie(JwtTokens.REFRESH_TOKEN_COOKIE_NAME, this.refreshToken));
		assertEquals(200, response.getStatus().getStatusCode(), &quot;Should be successful&quot;);

		// Extract the access token
		Token token = response.getJson(200, Token.class);
		assertNotNull(token.getToken(), &quot;Should have access token&quot;);
		assertNotEquals(this.accessToken, token.getToken(), &quot;Should be new access token&quot;);
	}

	@Test
	public void jwksPublishing() throws Exception {

		// Publish keys via JWKS
		MockWoofResponse response = this.server.send(MockWoofServer.mockRequest(&quot;/jwks.json&quot;).secure(true));

		// Should have two keys available (one active and one in future rotation)
		JwksKeys keys = response.getJson(200, JwksKeys.class);
		assertEquals(2, keys.getKeys().size(), &quot;Incorrect number of keys&quot;);
	}

	@Data
	public static class JwksKeys {
		private List&lt;RsaJwksKey&gt; keys;
	}

	@Data
	public static class RsaJwksKey {

		// As per RFC 7517 for RSA public key
		private String kty;
		private String n;
		private String e;

		// Additional to allow rotating keys
		private Long nbf; // epoch start time in seconds
		private Long exp; // epoch expire time in seconds
	}

}
</pre></div></div></div>
<div class="section">
<h2><a name="Next"></a>Next</h2>
<p>The <a href="../JwtHttpServer/index.html">next tutorial</a> covers combining JWT security and JWT authority server together for smaller applications.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                                <p class="pull-right">Copyright &copy;                    2005&#x2013;2021
                        <a href="http://officefloor.net">OfficeFloor</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
