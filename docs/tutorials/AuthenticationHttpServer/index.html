<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2020-10-30 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Daniel Sagenschneider" />
    <meta name="Date-Revision-yyyymmdd" content="20201030" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Authentication HTTP Server Tutorial &#x2013; Authentication Tutorial</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

          <!-- shortcut icon -->
			<link rel="shortcut icon" href="/favicon.ico" />
			
			<!-- www.addthis.com (for sharing) -->
			<script type="text/javascript">
				$(document).ready(function() {
					var addThisScript = document.createElement("script");
					addThisScript.type = 'text/javascript';
					addThisScript.src = '//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c6e0c0bac25d2cf';
					document.body.appendChild(addThisScript);
				})
			</script>
                  <!-- Google Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-23477455-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
          </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="https://github.com/officefloor/OfficeFloor">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://www.officefloor.net/" id="bannerLeft">
                                                                                                <img src="../../images/OfficeFloorBannerImage.png"  alt="OfficeFloor"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                              <li class="">
                    <a href="../../index.html" title="OfficeFloor">
        OfficeFloor</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="../index.html" title="Tutorials">
        Tutorials</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="index.html" title="Authentication HTTP Server Tutorial">
        Authentication HTTP Server Tutorial</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Authentication Tutorial</li>
        
              
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2020-10-30</li>
              <li id="projectVersion" class="pull-right">
                    Version: 3.28.0
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Parent Project</li>
                              
      <li>
  
                          <a href="../index.html" title="Tutorials">
          <span class="none"></span>
        Tutorials</a>
            </li>
            </ul>
              
                            <form id="search-form" action="https://www.google.com/search" method="get" >
    
  <input value="officefloor.net/officefloor/tutorials/AuthenticationHttpServer/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="https://cse.google.com/brand?form=search-form"></script>
          
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                                                                                                                         <a href="https://github.com/sponsors/sagenschneider" title="Support" class="builtBy">
        <img class="builtBy"  alt="Support" src="../../images/sponsor.jpg"    />
      </a>
                      </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <div class="section">
<h2><a name="Authentication_Tutorial"></a>Authentication Tutorial</h2>
<p>This tutorial looks at configuring authentication.</p>
<p>WoOF provides various authentication schemes along with the ability to customise your own authentication scheme (see <a href="/apidocs/net/officefloor/web/spi/security/HttpSecuritySource.html">HttpSecuritySource</a> for more details). This tutorial will focus on form based authentication.</p>
<p>The below example for this tutorial will demonstrate only allowing a logged in user to view a page. The simple key pages for this tutorial are as follows:</p><img src="./images/AuthenticationHttpServer-login-screenshot.png" alt="AuthenticationHttpServer login screen shot." /><img src="./images/AuthenticationHttpServer-hello-screenshot.png" alt="AuthenticationHttpServer hello screen shot." />
<p><a class="externalLink" href="https://github.com/officefloor/OfficeFloor/tree/master/officefloor/tutorials/AuthenticationHttpServer">Tutorial Source</a></p>
<div class="section">
<h3><a name="Restricted_access_page"></a>Restricted access page</h3>
<p>The page being restricted from access is as follows.</p>
<div class="source"><pre class="prettyprint">&lt;html&gt;
	&lt;body&gt;
		&lt;p&gt;Hi ${username}&lt;/p&gt;
		&lt;br /&gt;
		&lt;p&gt;&lt;a href=&quot;#{logout}&quot;&gt;logout&lt;/a&gt;&lt;/p&gt;
	&lt;/body&gt;
&lt;/html&gt;
</pre></div>
<p>With the backing logic class.</p>
<div class="source"><pre class="prettyprint">public class HelloLogic {

	@Data
	public static class TemplateData {

		private final String username;

	}

	@HttpAccess
	public TemplateData getTemplateData(HttpAccessControl accessControl) {
		String username = accessControl.getPrincipal().getName();
		return new TemplateData(username);
	}

	@Next(&quot;LoggedOut&quot;)
	public void logout(HttpAuthentication&lt;?&gt; authentication) {
		authentication.logout(null);
	}

}
</pre></div>
<p>The dependency on <a href="/apidocs/net/officefloor/web/spi/security/HttpSecurity.html">HttpSecurity</a> requires the user to be logged in. Should the user not be authenticated, creation of this dependency will cause a <a href="/apidocs/net/officefloor/web/security/AuthenticationRequiredException.html">AuthenticationRequiredException</a> to be thrown. WoOF automatically handles this exception by:</p>
<ol style="list-style-type: decimal">
<li>saving the current request in the HTTP session</li>
<li>send a challenge (in this case sending back the login page)</li>
<li>authenticate the user (in this case validate the entered username and password)</li>
<li>on authenticating the user, continue with the saved request</li></ol>
<p>Since the <tt>getTemplateData</tt> requires a logged in user the page will not be rendered unless there is a logged in user.</p>
<p>To allow the page to be rendered with or without a logged in user, depend on <a href="/apidocs/net/officefloor/web/security/HttpAuthentication.html">HttpAuthentication</a> to check if the user is logged in.</p></div>
<div class="section">
<h3><a name="Configuring_access"></a>Configuring access</h3>
<p>The following is the configuration for authentication.</p><img src="./images/AuthenticationHttpServer-configuration.png" alt="Authentication configuration screen shot." />
<p>While some authentication schemes are straight forward (e.g. <a href="/apidocs/net/officefloor/web/security/scheme/BasicHttpSecuritySource.html">Basic</a>), others such as <a href="/apidocs/net/officefloor/web/security/scheme/FormHttpSecuritySource.html">form based login</a> require application specific behaviour (e.g. a form login page). On selecting the authentication scheme, flows necessary for the chosen authentication will be displayed for configuration. In the case of this tutorial, the form login flow and authentication flow are required to be configured to/from the login page. This allows the application to tailor the login page while still being able to re-use the <a href="/apidocs/net/officefloor/web/security/scheme/FormHttpSecuritySource.html">FormHttpSecuritySource</a>.</p>
<p>To enable differing credential stores (e.g. database, LDAP, etc), the WoOF supplied authentication depends on a <a href="/apidocs/net/officefloor/web/security/store/CredentialStore.html">CredentialStore</a> managed object being configured. The following is the managed object configuration for this tutorial. </p>
<div class="source"><pre class="prettyprint">&lt;objects&gt;

	&lt;managed-object source=&quot;net.officefloor.web.security.store.MockCredentialStoreManagedObjectSource&quot; 
					type=&quot;net.officefloor.web.security.store.CredentialStore&quot; /&gt;

&lt;/objects&gt;
</pre></div>
<p>In this case a mock implementation is used that validates the user by ensuring the password matches the username. This is a simple implementation useful for testing.</p>
<p>For production, another <a href="/apidocs/net/officefloor/web/security/store/CredentialStore.html">CredentialStore</a> should be used. WoOF comes with existing implementations for standard credential stores. Customised implementations may also be used for bespoke environments.</p></div>
<div class="section">
<h3><a name="Login_page"></a>Login page</h3>
<p>The login page is as follows.</p>
<div class="source"><pre class="prettyprint">&lt;html&gt;
	&lt;head&gt;
		&lt;title&gt;Login&lt;/title&gt;
	&lt;/head&gt;
	&lt;body&gt;
		&lt;form action=&quot;#{login}&quot; method=&quot;POST&quot;&gt;
			Username: &lt;input type=&quot;text&quot; name=&quot;username&quot; /&gt; &lt;br /&gt;
			Password: &lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt; &lt;br /&gt;
			&lt;input type=&quot;submit&quot; value=&quot;login&quot; /&gt;
		&lt;/form&gt;
	&lt;/body&gt;
&lt;/html&gt;
</pre></div>
<p>With the backing logic class.</p>
<div class="source"><pre class="prettyprint">public class LoginLogic {

	@Data
	@HttpParameters
	public static class Form implements Serializable {
		private static final long serialVersionUID = 1L;

		private String username;

		private String password;
	}

	@FlowInterface
	public static interface Flows {

		void authenticate(HttpCredentials credentials);
	}

	public void login(Form form, Flows flows) {
		flows.authenticate(new HttpCredentialsImpl(form.getUsername(), form.getPassword()));
	}

}
</pre></div>
<p>The <a href="/apidocs/net/officefloor/web/security/scheme/FormHttpSecuritySource.html">FormHttpSecuritySource</a> requires the credentials to be provided within a <a href="/apidocs/net/officefloor/web/security/HttpCredentials.html">HttpCredentials</a> as a parameter.</p></div>
<div class="section">
<h3><a name="Remaining_code"></a>Remaining code</h3>
<p>The remaining code is included for completeness.</p>
<div class="section">
<h4><a name="Logout_page"></a>Logout page</h4>
<div class="source"><pre class="prettyprint">&lt;html&gt;
	&lt;head&gt;
		&lt;title&gt;Logout&lt;/title&gt;
	&lt;/head&gt;
	&lt;body&gt;
		&lt;a href=&quot;#{hello}&quot;&gt;Hello&lt;/a&gt;
	&lt;/body&gt;
&lt;/html&gt;
</pre></div></div>
<div class="section">
<h4><a name="Error_page"></a>Error page</h4>
<div class="source"><pre class="prettyprint">&lt;html&gt;
	&lt;body&gt;
		An error occurred.
	&lt;/body&gt;
&lt;/html&gt;
</pre></div></div></div>
<div class="section">
<h3><a name="Unit_Test"></a>Unit Test</h3>
<p>The unit test demonstrates logging in and logging out. </p>
<div class="source"><pre class="prettyprint">	@RegisterExtension
	public final MockWoofServerExtension server = new MockWoofServerExtension();

	private WritableHttpCookie session;

	@Test
	public void login() throws Exception {

		// Ensure require login to get to page
		MockHttpResponse loginRedirect = this.server.send(MockHttpServer.mockRequest(&quot;/hello&quot;));
		assertEquals(303, loginRedirect.getStatus().getStatusCode(), &quot;Ensure redirect&quot;);
		loginRedirect.assertHeader(&quot;location&quot;, &quot;https://mock.officefloor.net/login&quot;);

		// Obtain the session cookie
		this.session = loginRedirect.getCookie(HttpSessionManagedObjectSource.DEFAULT_SESSION_ID_COOKIE_NAME);

		// Login
		MockHttpRequestBuilder loginRequest = MockHttpServer.mockRequest(&quot;/login+login?username=Daniel&amp;password=Daniel&quot;)
				.secure(true).cookie(this.session.getName(), this.session.getValue());
		MockHttpResponse loggedInRedirect = this.server.send(loginRequest);
		assertEquals(200, loggedInRedirect.getStatus().getStatusCode(),
				&quot;Ensure successful login: &quot; + loggedInRedirect.getEntity(null));

		// Ensure now able to access hello page
		MockHttpResponse helloPage = this.server
				.send(MockHttpServer.mockRequest(&quot;/hello&quot;).cookie(this.session.getName(), this.session.getValue()));
		String helloPageContent = helloPage.getEntity(null);
		assertEquals(200, helloPage.getStatus().getStatusCode(), &quot;Should obtain hello page: &quot; + helloPageContent);
		assertTrue(helloPageContent.contains(&quot;&lt;p&gt;Hi Daniel&lt;/p&gt;&quot;), &quot;Ensure hello page with login: &quot; + helloPageContent);
	}

	@Test
	public void logout() throws Exception {

		// Login
		this.login();

		// Logout
		MockHttpResponse logoutRedirect = this.server.send(
				MockHttpServer.mockRequest(&quot;/hello+logout&quot;).cookie(this.session.getName(), this.session.getValue()));
		assertEquals(303, logoutRedirect.getStatus().getStatusCode(),
				&quot;Ensure logout: &quot; + logoutRedirect.getEntity(null));
		logoutRedirect.assertHeader(&quot;location&quot;, &quot;/logout&quot;);

		// Attempt to go back to page (but require login)
		MockHttpResponse loginPage = this.server
				.send(MockHttpServer.mockRequest(&quot;/hello&quot;).cookie(this.session.getName(), this.session.getValue()));
		assertEquals(303, loginPage.getStatus().getStatusCode(), &quot;Ensure redirect&quot;);
		loginPage.assertHeader(&quot;location&quot;, &quot;https://mock.officefloor.net/login&quot;);
	}
</pre></div></div></div>
<div class="section">
<h2><a name="Next"></a>Next</h2>
<p>Return to the <a href="../index.html">tutorials</a>.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                                <p class="pull-right">Copyright &copy;                    2005&#x2013;2020
                        <a href="http://officefloor.net">OfficeFloor</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
