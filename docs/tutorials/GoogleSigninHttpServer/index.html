<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2021-01-21 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Daniel Sagenschneider" />
    <meta name="Date-Revision-yyyymmdd" content="20210121" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Google Signin Tutorial &#x2013; Google Sign-in Tutorial</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

          <!-- shortcut icon -->
			<link rel="shortcut icon" href="/favicon.ico" />
			
			<!-- www.addthis.com (for sharing) -->
			<script type="text/javascript">
				$(document).ready(function() {
					var addThisScript = document.createElement("script");
					addThisScript.type = 'text/javascript';
					addThisScript.src = '//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c6e0c0bac25d2cf';
					document.body.appendChild(addThisScript);
				})
			</script>
                  <!-- Google Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-23477455-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
          </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="https://github.com/officefloor/OfficeFloor">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="https://officefloor.net/" id="bannerLeft">
                                                                                        <img src="https://officefloor.net/images/OfficeFloorBannerImage.png"  alt="OfficeFloor"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                              <li class="">
                    <a href="../../index.html" title="OfficeFloor">
        OfficeFloor</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="../index.html" title="Tutorials">
        Tutorials</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="index.html" title="Google Signin Tutorial">
        Google Signin Tutorial</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Google Sign-in Tutorial</li>
        
              
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2021-01-21</li>
              <li id="projectVersion" class="pull-right">
                    Version: 3.31.0
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Parent Project</li>
                              
      <li>
  
                          <a href="../index.html" title="Tutorials">
          <span class="none"></span>
        Tutorials</a>
            </li>
            </ul>
              
                            <form id="search-form" action="https://www.google.com/search" method="get" >
    
  <input value="officefloor.net/officefloor/tutorials/GoogleSigninHttpServer/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="https://cse.google.com/brand?form=search-form"></script>
          
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                                                                                                                   <a href="https://github.com/sponsors/sagenschneider" title="Support" class="builtBy">
        <img class="builtBy"  alt="Support" src="https://officefloor.net/images/sponsor.jpg"    />
      </a>
                      </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <div class="section">
<h2><a name="Google_Sign-in_Tutorial"></a>Google Sign-in Tutorial</h2>
<p>This tutorial demonstrates <a class="externalLink" href="https://developers.google.com/identity/sign-in/web/">Google Sign-in</a> integrated into WoOF.</p>
<p><a class="externalLink" href="https://github.com/officefloor/OfficeFloor/tree/master/officefloor/tutorials/GoogleSigninHttpServer">Tutorial Source</a></p>
<div class="section">
<h3><a name="Sign-in_JavaScript"></a>Sign-in JavaScript</h3>
<p>As per the <a class="externalLink" href="https://developers.google.com/identity/sign-in/web/">Google Sign-in tutorial</a>, Google sign-in is configured as follows.</p>
<p>Note that JQuery has been used. However, any supported web / mobile front-end technology can be used. See the <a class="externalLink" href="https://officefloor.appspot.com/">OfficeFloor Subscription App</a> for example (code available <a class="externalLink" href="https://github.com/officefloor/Subscription">here</a>).</p>
<div class="source"><pre class="prettyprint">&lt;html&gt;
&lt;head&gt;

&lt;!-- Google Sign in --&gt;
&lt;script src=&quot;https://apis.google.com/js/platform.js&quot; async defer&gt;&lt;/script&gt;
&lt;meta name=&quot;google-signin-client_id&quot;
	content=&quot;388391303753-jqugo4vugcf4po6pbenk7879f8er39h2.apps.googleusercontent.com&quot;&gt;

&lt;!-- JQuery (but can be any other library) --&gt;
&lt;script src=&quot;https://code.jquery.com/jquery-3.3.1.min.js&quot;
	integrity=&quot;sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=&quot;
	crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;

&lt;/head&gt;
&lt;body&gt;

	&lt;!-- Sign in --&gt;
	&lt;div class=&quot;g-signin2&quot; data-onsuccess=&quot;onSignIn&quot;&gt;&lt;/div&gt;
	&lt;div&gt;
		&lt;p id=&quot;name&quot;&gt;&lt;/p&gt;
		&lt;img id=&quot;profile&quot;&gt;&lt;/img&gt;
		&lt;p id=&quot;email&quot;&gt;&lt;/p&gt;
	&lt;/div&gt;
	&lt;script type=&quot;text/javascript&quot;&gt;
		function onSignIn(googleUser) {
			var profile = googleUser.getBasicProfile();
			$('#name').text('Hi ' + profile.getName());
			$('#profile').attr('src', profile.getImageUrl());

			// Send google login token to server
			$.ajax({
				type : &quot;POST&quot;,
				url : '/login',
				dataType : 'json',
				data : JSON.stringify({
					googleIdToken : googleUser.getAuthResponse().id_token
				}),
				contentType : 'application/json',
				success : function(result) {
					$('#email').text('Server retrieved email: ' + result.email)
				}
			})
		}
	&lt;/script&gt;

	&lt;!-- Sign out --&gt;
	&lt;p&gt;
		&lt;a href=&quot;#&quot; onclick=&quot;signOut();&quot;&gt;Sign out&lt;/a&gt;
	&lt;/p&gt;
	&lt;script&gt;
		function signOut() {
			gapi.auth2.getAuthInstance().signOut().then(function() {
				$('#name').text('');
				$('#profile').attr('src', '');
				$('#email').text('')
			});
		}
	&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;
</pre></div>
<p>This will use the Google sign-in features and send the Google Id Token to WoOF to login in the user. This is confirmed by displaying the user's email (sent back from the WoOF server).</p></div>
<div class="section">
<h3><a name="Configuring_Google_Sign-in_Integration"></a>Configuring Google Sign-in Integration</h3>
<p>Google sign-in is configured in <tt>application.objects</tt> as follows:</p>
<div class="source"><pre class="prettyprint">&lt;objects&gt;

	&lt;managed-object source=&quot;net.officefloor.identity.google.GoogleIdTokenVerifierManagedObjectSource&quot;&gt;
		&lt;property name=&quot;google.client.id&quot; value=&quot;388391303753-jqugo4vugcf4po6pbenk7879f8er39h2.apps.googleusercontent.com&quot; /&gt;
	&lt;/managed-object&gt;

&lt;/objects&gt;
</pre></div>
<p>This is used by the following service method to verify the user login and send back the email:</p>
<div class="source"><pre class="prettyprint">public class LoginLogic {

	@HttpObject
	@Data
	@AllArgsConstructor
	@NoArgsConstructor
	public static class LoginRequest {
		private String googleIdToken;
	}

	@Data
	@AllArgsConstructor
	public static class LoginResponse {
		private String email;
	}

	public void login(LoginRequest request, GoogleIdTokenVerifier tokenVerifier, ObjectResponse&lt;LoginResponse&gt; response)
			throws Exception {

		// Verify the token
		GoogleIdToken token = tokenVerifier.verify(request.getGoogleIdToken());

		// Send email response
		response.send(new LoginResponse(token.getPayload().getEmail()));
	}

}
</pre></div></div>
<div class="section">
<h3><a name="Testing"></a>Testing</h3>
<p>To avoid having to call Google with real users, the following unit tests demonstrates creating mock tokens:</p>
<div class="source"><pre class="prettyprint">	@Order(1)
	@RegisterExtension
	public final GoogleIdTokenExtension googleSignin = new GoogleIdTokenExtension();

	@Order(2)
	@RegisterExtension
	public final MockWoofServerExtension server = new MockWoofServerExtension();

	@Test
	public void ensureLogin() throws Exception {

		// Create mock token
		String token = this.googleSignin.getMockIdToken(&quot;TEST&quot;, &quot;mock@officefloor.net&quot;);

		// Ensure can login
		MockWoofResponse response = this.server
				.send(MockWoofServer.mockJsonRequest(HttpMethod.POST, &quot;/login&quot;, new LoginRequest(token)));
		response.assertJson(200, new LoginResponse(&quot;mock@officefloor.net&quot;));
	}
</pre></div>
<p>JUnit 4 example:</p>
<div class="source"><pre class="prettyprint">	private final GoogleIdTokenRule googleSignin = new GoogleIdTokenRule();

	private final MockWoofServerRule server = new MockWoofServerRule();

	@Rule
	public final RuleChain order = RuleChain.outerRule(this.googleSignin).around(this.server);

	@Test
	public void ensureLogin() throws Exception {

		// Create mock token
		String token = this.googleSignin.getMockIdToken(&quot;TEST&quot;, &quot;mock@officefloor.net&quot;);

		// Ensure can login
		MockWoofResponse response = this.server
				.send(MockWoofServer.mockJsonRequest(HttpMethod.POST, &quot;/login&quot;, new LoginRequest(token)));
		response.assertJson(200, new LoginResponse(&quot;mock@officefloor.net&quot;));
	}
</pre></div></div></div>
<div class="section">
<h2><a name="Next"></a>Next</h2>
<p>The <a href="../ObjectifyHttpServer/index.html">next tutorial</a> covers using Objectify for the Google App Engine DataStore.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                                <p class="pull-right">Copyright &copy;                    2005&#x2013;2021
                        <a href="http://officefloor.net">OfficeFloor</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
