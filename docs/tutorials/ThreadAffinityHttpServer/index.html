<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2021-07-02 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Daniel Sagenschneider" />
    <meta name="Date-Revision-yyyymmdd" content="20210702" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Thread Affinity Tutorial &#x2013; Thread Affinity Tutorial</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

          <!-- shortcut icon -->
			<link rel="shortcut icon" href="/favicon.ico" />
			
			<!-- www.addthis.com (for sharing) -->
			<script type="text/javascript">
				$(document).ready(function() {
					var addThisScript = document.createElement("script");
					addThisScript.type = 'text/javascript';
					addThisScript.src = '//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c6e0c0bac25d2cf';
					document.body.appendChild(addThisScript);
				})
			</script>
                  <!-- Google Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-23477455-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
          </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="https://github.com/officefloor/OfficeFloor">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="https://officefloor.net/" id="bannerLeft">
                                                                                        <img src="https://officefloor.net/images/OfficeFloorBannerImage.png"  alt="OfficeFloor"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                              <li class="">
                    <a href="../../index.html" title="OfficeFloor">
        OfficeFloor</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="../index.html" title="Tutorials">
        Tutorials</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="index.html" title="Thread Affinity Tutorial">
        Thread Affinity Tutorial</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Thread Affinity Tutorial</li>
        
              
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2021-07-02</li>
              <li id="projectVersion" class="pull-right">
                    Version: 3.37.0
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Parent Project</li>
                              
      <li>
  
                          <a href="../index.html" title="Tutorials">
          <span class="none"></span>
        Tutorials</a>
            </li>
            </ul>
              
                            <form id="search-form" action="https://www.google.com/search" method="get" >
    
  <input value="officefloor.net/officefloor/tutorials/ThreadAffinityHttpServer/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="https://cse.google.com/brand?form=search-form"></script>
          
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                                                                                                                   <a href="https://github.com/sponsors/sagenschneider" title="Support" class="builtBy">
        <img class="builtBy"  alt="Support" src="https://officefloor.net/images/sponsor.jpg"    />
      </a>
                      </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <div class="section">
<h2><a name="Thread_Affinity_Tutorial"></a>Thread Affinity Tutorial</h2>
<p>This tutorial looks at configuring an <a href="/apidocs/net/officefloor/frame/api/executive/source/ExecutiveSource.html">ExecutiveSource</a> to provide thread affinity for a web application.</p>
<p>To demonstrate the thread affinity, the following simple application is used.</p><img src="./images/threadaffinity-screenshot.png" alt="Thread Affinity screen shot." />
<p><a class="externalLink" href="https://github.com/officefloor/OfficeFloor/tree/master/officefloor/tutorials/ThreadAffinityHttpServer">Tutorial Source</a></p>
<div class="section">
<h3><a name="Thread_Affinity"></a>Thread Affinity</h3>
<p>Thread affinity binds the thread to only run on a particular CPU core. The advantage of using thread affinity is that it can increase the CPU cache hits, as the thread will always be run on a particular core. Increasing CPU cache hits reduces bus contention and improves performance of processing.</p>
<p>However, thread affinity is not a silver bullet to improving performance. There can be circumstances of cache sizes increasing causing the cache hits to drop. However, in many cases it can provide an increased boost in performance to your applications.</p>
<p>Always performance test to ensure thread affinity is providing your application the increased CPU cache hits and subsequent increased performance.</p></div></div>
<div class="section">
<h2><a name="WebThreadAffinityExecutiveSource"></a><a href="/apidocs/net/officefloor/web/executive/WebThreadAffinityExecutiveSource.html">WebThreadAffinityExecutiveSource</a></h2>
<p>Thread affinity is not straight forward to implement. However, OfficeFloor makes it simple via the <a href="/apidocs/net/officefloor/web/executive/WebThreadAffinityExecutiveSource.html">WebThreadAffinityExecutiveSource</a> (that uses <a class="externalLink" href="https://github.com/OpenHFT/Java-Thread-Affinity">OpenHFT</a>).</p>
<p><b>Please ensure you follow the instructions on <a class="externalLink" href="https://github.com/OpenHFT/Java-Thread-Affinity">OpenHFT</a> to install the necessary native libraries for thread affinity to work.</b></p>
<p>Then simply include the following on the class path:</p>
<div class="source"><pre class="prettyprint">		&lt;dependency&gt;
			&lt;groupId&gt;net.officefloor.web&lt;/groupId&gt;
			&lt;artifactId&gt;officeweb_executive&lt;/artifactId&gt;
		&lt;/dependency&gt;
</pre></div>
<p>This will set up thread affinity for:</p>
<p>- HTTP servicing threads</p>
<p>- all teams (each team is split to run across the CPU cores with their threads bound to a particular core)</p>
<p>The result of this is that the web request is serviced entirely on one CPU core. This allows for improved CPU cache hits even if you require multiple threads (teams) to service the request. All threads for servicing the request will be bound to the same CPU core. This subsequently, in many cases, boosts your application performance - as each CPU core can act like it's own server without having to have <i>heavy weight</i> synchronising between the cores slowing application performance.</p>
<div class="section">
<h3><a name="Proving_the_Thread_Affinity"></a>Proving the Thread Affinity</h3>
<p>The tutorial outputs the name of the thread at the top of the page. The thread name is comprised of:</p>
<ol style="list-style-type: decimal">
<li>The naming of the bound dependency</li>
<li>The CPU core that the thread is bound</li>
<li>Index of the thread within the thread pool</li></ol>
<p>As the invoking thread is bound to a CPU core on triggering the mock request, running the request multiple times should always have the same CPU core.</p>
<p>The following test demonstrates the same CPU core always servicing the request.</p>
<div class="source"><pre class="prettyprint">	@RegisterExtension
	public final MockWoofServerExtension server = new MockWoofServerExtension();

	@Test
	public void sameThreadPoolDueToAffinity() throws Exception {

		// On multiple calls, should be same core (as locks affinity)
		String previousCore = null;
		for (int i = 0; i &lt; 100; i++) {

			// GET entry
			MockHttpResponse response = this.server.send(MockHttpServer.mockRequest(&quot;/&quot;));
			String html = response.getEntity(null);
			assertEquals(200, response.getStatus().getStatusCode(), &quot;Should be successful: &quot; + html);

			// Parse out the core
			Pattern pattern = Pattern.compile(&quot;.*CORE-(\\d+)-.*&quot;, Pattern.DOTALL);
			Matcher matcher = pattern.matcher(html);
			assertTrue(matcher.matches(), &quot;Should be able to obtain thread affinity core&quot;);
			String core = matcher.group(1);

			// Ensure same as previous core (ignoring first call)
			if (previousCore != null) {
				assertEquals(previousCore, core, &quot;Should be locked to same core&quot;);
			}

			// Set up for next call
			previousCore = core;
		}
	}
</pre></div></div>
<div class="section">
<h3><a name="ExecutiveSource"></a>ExecutiveSource</h3>
<p>For further details on how you can control threads within an application see the <a href="/apidocs/net/officefloor/frame/api/executive/source/ExecutiveSource.html">ExecutiveSource</a>. It is beyond this tutorial to explain it's full capabilities, however it is geared to following how the executives would manage personal in an office.</p></div></div>
<div class="section">
<h2><a name="Next"></a>Next</h2>
<p>The <a href="../KotlinHttpServer/index.html">next tutorial</a> covers Kotlin.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                                <p class="pull-right">Copyright &copy;                    2005&#x2013;2021
                        <a href="http://officefloor.net">OfficeFloor</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
